<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Inloggning till Portal</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    #loginForm { max-width: 400px; margin-top: 20px; }
    .success { color: green; font-weight: bold; }
    .error { color: red; }
  </style>
</head>
<body>
  <form id="loginForm">
    <h1>Rönnes Filmklubb inlogg:</h1>
    <label for="email">E-postadress:</label><br />
    <input type="email" id="email" required placeholder="din.adress@doman.se" /><br /><br />
    <button type="submit" id="submitButton">Få Inloggningskod</button>
  </form>

  <form id="otpForm" style="display: none;">
    <p>En kod har skickats till din e-post. Ange den nedan.</p>
    <label for="otp">Engångskod:</label><br />
    <input type="text" id="otp" required placeholder="Skriv in 6-siffrig kod" /><br /><br />
    <button type="submit" id="verifyButton">Logga in</button>
  </form>

  <div id="auth-status"></div>

  <div id="portalContent" style="display: none;">
    <h2>Välkommen! Du är inloggad.</h2>
    <p>Här är ditt portalinnehåll.</p>
    <button id="logoutButton">Logga ut</button>
  </div>

  <script type="module">
    // Use the ESM entry for supabase-js v2 from jsDelivr
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

    // ====================================================================
    // A. KONFIGURATION
    // ====================================================================
    const SUPABASE_URL = 'https://wqjnmwyuwxzfivrmzquq.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indxam5td3l1d3h6Zml2cm16cXVxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzNDMwMDksImV4cCI6MjA3NDkxOTAwOX0.UQpkYTTq2DUH5h8hBiSwNcvE7vDsBrArNC9uFPvyhPU'; // <-- Replace with your anon key

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Cache för DOM-element
    const loginForm = document.getElementById('loginForm');
    const portalContent = document.getElementById('portalContent');
    const authStatus = document.getElementById('auth-status');
    const otpForm = document.getElementById('otpForm');
    let currentEmail = ''; // Lagra e-postadressen tillfälligt för OTP-verifieringen

    // ====================================================================
    // B. FUNKTIONER FÖR INLOGGNING/UTLOGGNING (OTP-version)
    // ====================================================================

    async function signInWithEmail(email) {
      authStatus.innerHTML = 'Skickar kod...';
      currentEmail = email;

      const { error } = await supabase.auth.signInWithOtp({
        email: email,
        options: { shouldCreateUser: false }
      });

      if (error) {
        authStatus.innerHTML = `<p class="error">Inloggning misslyckades. Kontrollera e-post: ${error.message}</p>`;
      } else {
        authStatus.innerHTML = `<p class="success">Kod skickad. Kontrollera din inkorg.</p>`;
        loginForm.style.display = 'none';
        otpForm.style.display = 'block';
      }
    }

    async function verifyOtpCode(token) {
      authStatus.innerHTML = 'Verifierar kod...';

      const { error } = await supabase.auth.verifyOtp({
        email: currentEmail,
        token: token,
        type: 'email'
      });

      if (error) {
        authStatus.innerHTML = `<p class="error">Verifiering misslyckades: Ogiltig kod eller utgången.</p>`;
      } else {
        otpForm.style.display = 'none';
        authStatus.innerHTML = `<p class="success">Verifiering lyckades!</p>`;
      }
    }

    async function signOut() {
      await supabase.auth.signOut();
      updateUI();
    }

    async function getCurrentUserId() {
      const { data } = await supabase.auth.getUser();
      const user = data?.user ?? null;
      return user ? user.id : null;
    }

    async function fetchAndDisplayUserData(userId, email) {
      const { data, error } = await supabase
        .from('user_data')
        .select('rek_1_title, rek_1_link, rek_1_imdb, rek_2_title, rek_2_link, rek_2_imdb, grade_link')
        .eq('user_id', userId)
        .single();

      if (error && error.code !== 'PGRST116') {
        console.error("Fel vid hämtning av användardata:", error);
        portalContent.innerHTML = '<p class="error">Kunde inte ladda din data. (Kontrollera RLS)</p>';
        portalContent.style.display = 'block';
        return;
      }

      let contentHTML = '';
      if (data) {
        contentHTML = `
          <h2>Välkommen, ${email}!</h2>
          <p><strong><a>Våra filmer ligger på Cineasterna, en streamingtjänst som du har tillgång till via ditt bibliotek</strong> href="https://cineast.zendesk.com/hc/sv"Cineasterna Help</a></p>
          <p><strong>Rekomendation ett:</strong> ${data.rek_1_title || ''}</p>
          ${data.rek_1_link ? `<p><a href="${data.rek_1_link}" target="_blank" rel="noopener">Se filmen här!</a></p>` : ''}
          ${data.rek_1_imdb ? `<p><a href="${data.rek_1_imdb}" target="_blank" rel="noopener">Läs om filmen här!</a></p>` : ''}
          <p><strong>Rekomendation två:</strong> ${data.rek_2_title || ''}</p>
          ${data.rek_2_link ? `<p><a href="${data.rek_2_link}" target="_blank" rel="noopener">Se filmen här!</a></p>` : ''}
          ${data.rek_2_imdb ? `<p><a href="${data.rek_2_imdb}" target="_blank" rel="noopener">Läs om filmen här!</a></p>` : ''}
          ${data.grade_link ? `<p><a href="${data.grade_link}" target="_blank" rel="noopener">Glöm inte att betygsätt filmen efter att du sett den!</a></p>` : ''}
          
        `;
      } else {
        contentHTML = `
          <h2>Välkommen, ${email}!</h2>
          <p>Ingen specifik data hittades för ditt konto. Kontakta support.</p>
        `;
      }

      portalContent.innerHTML = contentHTML + '<button id="logoutButton">Logga ut</button>';
      document.getElementById('logoutButton').addEventListener('click', signOut);

      portalContent.style.display = 'block';
      authStatus.innerHTML = '';
    }

    async function updateUI() {
      const userId = await getCurrentUserId();

      if (userId) {
        const { data } = await supabase.auth.getUser();
        const userEmail = data?.user?.email ?? '';
        loginForm.style.display = 'none';
        otpForm.style.display = 'none';

        await fetchAndDisplayUserData(userId, userEmail);
      } else {
        loginForm.style.display = 'block';
        otpForm.style.display = 'none';
        portalContent.style.display = 'none';
        authStatus.innerHTML = '<p>Vänligen ange din e-post för att få koden.</p>';
      }
    }

    // ====================================================================
    // C. EVENT LYSSNARE & INITIERING
    // ====================================================================

    loginForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const email = document.getElementById('email').value;
      signInWithEmail(email);
    });

    otpForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const otp = document.getElementById('otp').value;
      verifyOtpCode(otp);
    });

    supabase.auth.onAuthStateChange((event, session) => {
      if (event === 'SIGNED_IN' || event === 'SIGNED_OUT') {
        updateUI();
      }
    });

    // Initial laddning av UI
    updateUI();
  </script>
</body>
</html>


