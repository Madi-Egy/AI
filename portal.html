<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inloggning till Portal</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* Lite grundläggande CSS för demonstration */
        body { font-family: sans-serif; padding: 20px; }
        #loginForm { max-width: 400px; margin-top: 20px; }
        .success { color: green; font-weight: bold; }
        .error { color: red; }
    </style>
</head>
<body>
<form id="loginForm">
    <h1>Rönnes Filmklubb inlogg:</h1>
    <label for="email">E-postadress:</label><br>
    <input type="email" id="email" required placeholder="din.adress@doman.se"><br><br>
    <button type="submit" id="submitButton">Få Inloggningskod</button>
</form>

<form id="otpForm" style="display: none;">
    <p>En kod har skickats till din e-post. Ange den nedan.</p>
    <label for="otp">Engångskod:</label><br>
    <input type="text" id="otp" required placeholder="Skriv in 6-siffrig kod"><br><br>
    <button type="submit" id="verifyButton">Logga in</button>
</form>


    <div id="auth-status"></div>

    <div id="portalContent" style="display: none;">
        <h2>Välkommen! Du är inloggad.</h2>
        <p>Här är ditt portalinnehåll.</p>
        <button id="logoutButton">Logga ut</button>
    </div>

    <script>
     // ====================================================================
// A. KONFIGURATION
// ====================================================================

// ERSÄTT DESSA MED DINA EGNA NYCKLAR FRÅN SUPABASE DASHBOARD
const SUPABASE_URL = 'https://wqjnmwyuwxzfivrmzquq.supabase.co'; 
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indxam5td3l1d3h6Zml2cm16cXVxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkzNDMwMDksImV4cCI6MjA3NDkxOTAwOX0.UQpkYTTq2DUH5h8hBiSwNcvE7vDsBrArNC9uFPvyhPU'; 
const REDIRECT_URL = 'https://madi-egy.github.io/AI/portal.html'; // Där portalen ska hamna

const supabase = Supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// Cache för DOM-element
const loginForm = document.getElementById('loginForm');
const portalContent = document.getElementById('portalContent');
const authStatus = document.getElementById('auth-status');
const logoutButton = document.getElementById('logoutButton');


// =================== NYA CACHE-ELEMENT ===================
const otpForm = document.getElementById('otpForm');
let currentEmail = ''; // Lagra e-postadressen tillfälligt

// =================== 1. SKICKA KOD (OTP) ===================
async function signInWithEmail(email) {
    authStatus.innerHTML = 'Skickar kod...';
    currentEmail = email; // Spara e-posten
    
    // ANVÄND NU signInWithOtp UTAN 'emailRedirectTo'
    const { error } = await supabase.auth.signInWithOtp({
        email: email,
        options: {
            shouldCreateUser: false // Logga inte in nya användare, endast befintliga
        }
    });

    if (error) {
        authStatus.innerHTML = `<p class="error">Fel: ${error.message}</p>`;
    } else {
        authStatus.innerHTML = `<p class="success">Kod skickad. Kontrollera din inkorg.</p>`;
        loginForm.style.display = 'none';
        otpForm.style.display = 'block'; // Visa fältet för koden
    }
}

// =================== 2. VERIFIERA KODEN ===================
async function verifyOtpCode(token) {
    authStatus.innerHTML = 'Verifierar kod...';
    
    // Använd email som sparades efter första steget
    const { error } = await supabase.auth.verifyOtp({
        email: currentEmail,
        token: token,
        type: 'email' // Ange att det är en e-postkod
    });

    if (error) {
        authStatus.innerHTML = `<p class="error">Verifiering misslyckades: Ogiltig kod eller utgången.</p>`;
    } else {
        // Logik för att uppdatera UI körs nu via onAuthStateChange
        otpForm.style.display = 'none'; 
    }
}


// =================== C. EVENT LYSSNARE ===================

// 1. Hantera Skicka E-post (Kör signInWithEmail)
loginForm.addEventListener('submit', (e) => {
    e.preventDefault();
    const email = document.getElementById('email').value;
    signInWithEmail(email);
});

// 2. Hantera Verifiera Kod (Kör verifyOtpCode)
otpForm.addEventListener('submit', (e) => {
    e.preventDefault();
    const otp = document.getElementById('otp').value;
    verifyOtpCode(otp);
});

// (Resten av din kod, updateUI och onAuthStateChange, kan förbli som den är)
/**
 * Loggar ut användaren från Supabase.
 */
async function signOut() {
    await supabase.auth.signOut();
    updateUI();
}

... (behåll din signInWithEmail och signOut funktion) ...

/**
 * Hämtar den inloggade användarens ID och hämtar sedan data.
 * @returns {string | null} Användarens UUID eller null.
 */
async function getCurrentUserId() {
    const { data: { user } } = await supabase.auth.getUser();
    return user ? user.id : null; 
}


/**
 * Hämtar och visar den unika datan för den inloggade användaren.
 */
async function fetchAndDisplayUserData(userId, email) {
    // 1. Försök att hämta data från den skyddade tabellen
    const { data, error } = await supabase
        .from('user_data')
        .select('portal_status, latest_report_date, contact_person')
        .eq('user_id', userId) 
        .single(); // Förväntar sig bara en rad (din RLS skyddar resten!)

    // 2. Hantera fel och visa UI
    if (error && error.code !== 'PGRST116') { 
        // PGRST116 betyder "ingen data hittades", vilket vi hanterar
        console.error("Fel vid hämtning av användardata:", error);
        portalContent.innerHTML = '<p class="error">Kunde inte ladda din data på grund av ett fel.</p>';
    }
    
    // 3. Bygg upp det individuella innehållet
    let contentHTML;
    
    if (data) {
        // Data hittades, visa den
        contentHTML = `
            <h2>Välkommen, ${email}!</h2>
            <p><strong>Status:</strong> ${data.portal_status}</p>
            <p><strong>Senaste Rapport:</strong> ${data.latest_report_date}</p>
            <p><strong>Din Kontakt:</strong> ${data.contact_person}</p>
        `;
    } else {
        // Inloggad men ingen specifik data (kontrollera Steg 1.4)
         contentHTML = `
            <h2>Välkommen, ${email}!</h2>
            <p>Ingen specifik data hittades för ditt konto. Kontakta support.</p>
        `;
    }
    
    // 4. Visa innehållet och utloggningsknappen
    portalContent.innerHTML = contentHTML + '<button id="logoutButton">Logga ut</button>';
    document.getElementById('logoutButton').addEventListener('click', signOut);

    portalContent.style.display = 'block';
    authStatus.innerHTML = ''; // Rensa statusmeddelanden
}


/**
 * Kontrollerar den aktuella inloggningsstatusen och uppdaterar gränssnittet. (Huvudfunktionen)
 */
async function updateUI() {
    const { data: { user } } = await supabase.auth.getUser();

    if (user) {
        // Användaren är inloggad. Gå vidare till att hämta unik data.
        const userId = user.id;
        const userEmail = user.email;
        
        loginForm.style.display = 'none';
        
        // Hämta och visa den individuella informationen
        await fetchAndDisplayUserData(userId, userEmail); 
    } else {
        // Användaren är utloggad
        loginForm.style.display = 'block';
        portalContent.style.display = 'none';
        authStatus.innerHTML = '<p>Vänligen ange din e-post för att logga in.</p>';
    }
}

// ... (behåll dina eventlyssnare från Steg C) ...
// Observera att `logoutButton`-lyssnaren nu hanteras inuti `fetchAndDisplayUserData`.

// ====================================================================
// C. EVENT LYSSNARE & INITIERING
// ====================================================================

// 1. Hantera formulärinlämning
loginForm.addEventListener('submit', (e) => {
    e.preventDefault();
    const email = document.getElementById('email').value;
    signInWithEmail(email);
});

// 2. Hantera utloggning
logoutButton.addEventListener('click', signOut);

// 3. Lyssna på förändringar i autentiseringsstatus (t.ex. när länken klickas)
supabase.auth.onAuthStateChange((event, session) => {
    // Denna körs när en användare loggar in via Magic Link/OTP
    if (event === 'SIGNED_IN' || event === 'SIGNED_OUT') {
        updateUI();
    }
});

// 4. Initial laddning av UI
updateUI();
    </script>

</body>
</html>
